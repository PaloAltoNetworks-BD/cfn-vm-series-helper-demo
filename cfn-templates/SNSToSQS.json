{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation Template for SNS to SQS publishing",

  "Parameters" : {
    "VMseriesHelperUserPassword": {
      "NoEcho": "true",
      "Type": "String",
      "Description" : "Password for the IAM user VMseriesHelper",
      "MinLength": "1",
      "MaxLength": "41",
      "ConstraintDescription" : "password must be between 1 and 41 characters."
    }
  },

  "Resources" : {
    "VMseriesHelperSNSTopic" : {
      "Type" : "AWS::SNS::Topic",
      "Metadata": { "Comment": "No Topic or Name specified, ID will be autogenerated and used" },
      "Properties" : {
        "Subscription" : [ {
          "Endpoint" : { "Fn::GetAtt" : ["VMseriesHelperQueue", "Arn"]},
          "Protocol" : "sqs"
        } ]
      }
    },

    "VMseriesHelperQueue" : {
      "Type" : "AWS::SQS::Queue"
    },

    "VMseriesHelperUser" : {
     "Type" : "AWS::IAM::User",
     "Properties" : {
       "LoginProfile": {
         "Password": {"Ref" : "VMseriesHelperUserPassword"}
       }
     }
    },

    "VMseriesHelperUserKey" : {
     "Type" : "AWS::IAM::AccessKey",
     "Properties" : {
          "UserName" : {"Ref": "VMseriesHelperUser"}
      }
    },

    "VMseriesHelperQueueGroup" : {
      "Type" : "AWS::IAM::Group",
      "Properties" : {
        "Policies": [ {
          "PolicyName": "VMseriesHelperQueueGroupPolicy",
          "PolicyDocument": {
            "Statement":[ {
              "Effect":"Allow",
 	            "Action":[ "sqs:DeleteMessage", "sqs:ReceiveMessage" ],
              "Resource":[ { "Fn::GetAtt" : ["VMseriesHelperQueue", "Arn"]} ]
            }]
          }
        },
        {
          "PolicyName": "VMseriesHelperKeyPairGroupPolicy",
          "PolicyDocument": {
            "Statement":[ {
              "Effect":"Allow",
              "Action":[ "ec2:CreateKeyPair" ],
              "Resource":[ "*" ]          
            }]
          }
        }]
      }
    },

    "AddUserToVMseriesHelperQueueGroup" : {
      "Type" : "AWS::IAM::UserToGroupAddition",
      "Properties" : {
        "GroupName": {"Ref" : "VMseriesHelperQueueGroup"},
        "Users" : [{ "Ref" : "VMseriesHelperUser" }]
      }
    },

    "VMseriesHelperQueuePolicy" : {
      "Type" : "AWS::SQS::QueuePolicy",
      "Properties" : {
        "PolicyDocument":  {
          "Id":"VMseriesHelperQueuePolicy",
          "Statement" : [ {
            "Sid":"VMSeriesHelper-Allow-SendMessage-To-Queue-From-SNS",
	           "Effect":"Allow",
	           "Principal" : {"AWS" : "*"},
 	            "Action":["sqs:SendMessage"],
	           "Resource": "*",
            "Condition": {
              "ArnEquals": { "aws:SourceArn": { "Ref" : "VMseriesHelperSNSTopic" } }
            }
          } ]
        },
        "Queues" : [{"Ref" : "VMseriesHelperQueue"}]
      }
    }
  },

  "Outputs" : {
    "VMseriesHelperSNSTopicARN" : {
      "Value" : { "Ref" : "VMseriesHelperSNSTopic" },
      "Description" : "Topic ARN of VM-Series Helper"
    },
    "VMseriesHelperQueueInfo" : {
      "Value" : {"Fn::Join" : [ " ", [ "Name:", { "Fn::GetAtt" : [ "VMseriesHelperQueue", "QueueName" ] }, "URL:", { "Ref" : "VMseriesHelperQueue" } ] ]},
      "Description" : "VMseriesHelperQueue details"
    },
    "VMseriesHelperUser" : {
      "Description" : "Information for consumer",
      "Value" : {"Fn::Join" : [
        " ",
        [
          "ARN:",
          { "Fn::GetAtt" : [ "VMseriesHelperUser", "Arn" ] },
          "Access Key:",
          {"Ref" : "VMseriesHelperUserKey"},
          "Secret Key:",
          {"Fn::GetAtt" : ["VMseriesHelperUserKey", "SecretAccessKey"]}
        ]
      ]}
    }
  }
}
