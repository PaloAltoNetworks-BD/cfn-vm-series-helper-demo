{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "VM-Series-Helper Stack",

  "Parameters" : {
    "KeyName": {
      "Description": "Name of an existing Key Pair, it will be used to access VM-Series Helper instance",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern": "[\\x20-\\x7E]*",
      "ConstraintDescription": "can contain only ASCII characters."
    },

    "SecurityGroup": {
      "Description": "The security group to use for the VM-Series-Helper instance. Enable 80/tcp for the WebUI",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern": "[\\x20-\\x7E]*",
      "ConstraintDescription": "can contain only ASCII characters.",
      "Default": "default"      
    }
  },

  "Mappings": {
    "UbuntuAWSRegionMap" : {
      "us-east-1"      : { "AMI": "ami-88562de0" },
      "us-west-2"      : { "AMI": "ami-3bebb50b" },
      "us-west-1"      : { "AMI": "ami-4e120b0b" },
      "eu-west-1"      : { "AMI": "ami-314ecc46" },
      "ap-southeast-1" : { "AMI": "ami-da381388" },
      "ap-northeast-1" : { "AMI": "ami-0eb6aa0f" },
      "ap-southeast-2" : { "AMI": "ami-bbeb9e81" },
      "sa-east-1"      : { "AMI": "ami-79f54964" }
    }
  },

  "Resources" : {
    "VMseriesHelperSNSTopic" : {
      "Type" : "AWS::SNS::Topic",
      "Metadata": { "Comment": "No Topic or Name specified, ID will be autogenerated and used" },
      "Properties" : {
        "Subscription" : [ {
          "Endpoint" : { "Fn::GetAtt" : ["VMseriesHelperQueue", "Arn"]},
          "Protocol" : "sqs"
        } ]
      }
    },

    "VMseriesHelperQueue" : {
      "Type" : "AWS::SQS::Queue"
    },

    "VMseriesHelperUser" : {
     "Type" : "AWS::IAM::User"
    },

    "VMseriesHelperUserKey" : {
     "Type" : "AWS::IAM::AccessKey",
     "Properties" : {
          "UserName" : {"Ref": "VMseriesHelperUser"}
      }
    },

    "VMseriesHelperQueueGroup" : {
      "Type" : "AWS::IAM::Group",
      "Properties" : {
        "Policies": [ {
          "PolicyName": "VMseriesHelperQueueGroupPolicy",
          "PolicyDocument": {
            "Statement":[ {
              "Effect":"Allow",
 	            "Action":[ "sqs:DeleteMessage", "sqs:ReceiveMessage" ],
              "Resource":[ { "Fn::GetAtt" : ["VMseriesHelperQueue", "Arn"]} ]
            }]
          }
        },
        {
          "PolicyName": "VMseriesHelperKeyPairGroupPolicy",
          "PolicyDocument": {
            "Statement":[ {
              "Effect":"Allow",
              "Action":[ "ec2:CreateKeyPair" ],
              "Resource":[ "*" ]          
            }]
          }
        }]
      }
    },

    "AddUserToVMseriesHelperQueueGroup" : {
      "Type" : "AWS::IAM::UserToGroupAddition",
      "Properties" : {
        "GroupName": {"Ref" : "VMseriesHelperQueueGroup"},
        "Users" : [{ "Ref" : "VMseriesHelperUser" }]
      }
    },

    "VMseriesHelperQueuePolicy" : {
      "Type" : "AWS::SQS::QueuePolicy",
      "Properties" : {
        "PolicyDocument":  {
          "Id":"VMseriesHelperQueuePolicy",
          "Statement" : [ {
            "Sid":"VMSeriesHelper-Allow-SendMessage-To-Queue-From-SNS",
	           "Effect":"Allow",
	           "Principal" : {"AWS" : "*"},
 	            "Action":["sqs:SendMessage"],
	           "Resource": "*",
            "Condition": {
              "ArnEquals": { "aws:SourceArn": { "Ref" : "VMseriesHelperSNSTopic" } }
            }
          } ]
        },
        "Queues" : [{"Ref" : "VMseriesHelperQueue"}]
      }
    },

    "VMSeriesHelperInstance": {
      "Type" : "AWS::EC2::Instance",
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT5M"
        }
      },
      "Properties" : {
          "DisableApiTermination" : "false",
          "ImageId" : { "Fn::FindInMap" : [ "UbuntuAWSRegionMap", { "Ref" : "AWS::Region" }, "AMI" ] },
          "InstanceType" : "t1.micro",
          "KeyName" : { "Ref": "KeyName" },
          "SecurityGroups": [ {"Ref": "SecurityGroup"} ],
          "UserData" : { "Fn::Base64" : { "Fn::Join" : ["\n", [
            "#cloud-config",

            "apt_update: false",
            "apt_upgrade: false",

            "packages:",
            "    - nginx",
            "    - python-dev",
            "    - python-pip",
            "    - git",

            "runcmd:",
            "    - [pip, install, ansible]",
            "    - [pip, install, paramiko]",
            "    - [pip, install, boto]",
            "    - [pip, install, pan-python]",
            "    - [git, clone, -b, sesummit, --recursive, \"https://github.com/PaloAltoNetworks-BD/cfn-vm-series-helper-demo.git\", /opt/cfn-vm-series-helper-demo]",
            { "Fn::Join": ["", ["    - [export, AWS_REGION=", { "Ref": "AWS::Region" }, "]"]] },
            { "Fn::Join": ["", ["    - [export, AWS_ACCESS_KEY_ID=", { "Ref": "VMseriesHelperUserKey" }, "]"]] },
            { "Fn::Join": ["", ["    - [export, AWS_SECRET_ACCESS_KEY=", {"Fn::GetAtt" : ["VMseriesHelperUserKey", "SecretAccessKey"]}, "]"]] },
            { "Fn::Join": ["", ["    - [export, \"STACKNAME=", { "Ref": "AWS::StackName" }, "\"]"]] },
            { "Fn::Join": ["", ["    - [export, \"AWS_SQS_URL=", { "Ref" : "VMseriesHelperQueue" }, "\"]"]] },
            "    - [python, /opt/cfn-vm-series-helper-demo/installer.py]",
            "    - [rm, /etc/nginx/sites-enabled/default]",
            "    - [cp, /opt/cfn-vm-series-helper-demo/etc/vmsh, /etc/nginx/sites-enabled/]",
            "    - [cp, /opt/cfn-vm-series-helper-demo/etc/vmsh-htpasswd, /etc/nginx/]",
            "    - [service, nginx, restart]",
            "    - [pip, install, \"https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\"]",
            { "Fn::Join": ["", ["    - [cfn-signal, -e 0, --stack, ", { "Ref" : "AWS::StackName" }, ", --region, ", { "Ref" : "AWS::Region" },", --resource, VMSeriesHelperInstance]"]] },

            "output: {all: '| tee -a /var/log/cloud-config-output.log'}"
            ]]}
          }
      }
    }
  },

  "Outputs" : {
    "VMseriesHelperSNSTopicARN" : {
      "Value" : { "Ref" : "VMseriesHelperSNSTopic" },
      "Description" : "Topic ARN of VM-Series Helper"
    },
    "VMSHPublicDNSName": {
      "Description": "Public DNS of vm-series-helper instance",
      "Value": { "Fn::GetAtt": [ "VMSeriesHelperInstance", "PublicDnsName" ]}
    },
    "PAVMAWSKeyName": {
      "Description": "Name of SSH Public Key for PA-VM-AWS instances",
      "Value": { "Ref": "AWS::StackName" }
    }
  }
}
