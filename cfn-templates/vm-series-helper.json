{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "VM-Series Helper",

  "Parameters" : {
    "KeyName": {
      "Description": "Name of an existing Key Pair for the VM-Series Helper instance",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "AllowedPattern": "[\\x20-\\x7E]*",
      "ConstraintDescription": "can contain only ASCII characters."
    }
  },

  "Mappings": {
    "UbuntuAWSRegionMap" : {
      "us-east-1"      : { "AMI": "ami-88562de0" },
      "us-west-2"      : { "AMI": "ami-3bebb50b" },
      "us-west-1"      : { "AMI": "ami-4e120b0b" },
      "eu-west-1"      : { "AMI": "ami-314ecc46" },
      "ap-southeast-1" : { "AMI": "ami-da381388" },
      "ap-northeast-1" : { "AMI": "ami-0eb6aa0f" },
      "ap-southeast-2" : { "AMI": "ami-bbeb9e81" },
      "sa-east-1"      : { "AMI": "ami-79f54964" }
    }
  },

  "Resources" : {
    "VMSeriesHelperInstance": {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
          "DisableApiTermination" : "false",
          "ImageId" : { "Fn::FindInMap" : [ "UbuntuAWSRegionMap", { "Ref" : "AWS::Region" }, "AMI" ] },
          "InstanceType" : "t1.micro",
          "KeyName" : { "Ref": "KeyName" },
          "UserData" : { "Fn::Base64" : { "Fn::Join" : ["\n", [
            "#cloud-config",

            "package_update: true",
            "package_upgrade: true",
            "packages:",
            "    - python-dev",
            "    - python-pip",
            "    - git",

            "runcmd:",
            "    - [pip, install, ansible]",
            "    - [pip, install, paramiko]",
            "    - [pip, install, boto]",
            "    - [git, clone, \"https://github.com/PaloAltoNetworks-BD/cfn-vm-series-helper-demo.git\", /opt/cfn-vm-series-helper-demo]",
            { "Fn::Join": ["", ["    - [export, AWS_REGION=", { "Ref": "AWS::Region" }, "]"]] },
            { "Fn::Join": ["", ["    - [export, AWS_ACCESS_KEY_ID=", "AKIAIYS5QE4LIY2MABZA", "]"]] },
            { "Fn::Join": ["", ["    - [export, AWS_SECRET_ACCESS_KEY=", "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", "]"]] },
            { "Fn::Join": ["", ["    - [export, \"STACKNAME=", { "Ref": "AWS::StackName" }, "\"]"]] },
            { "Fn::Join": ["", ["    - [export, \"AWS_SQS_URL=", "https://sqs.eu-west-1.amazonaws.com/972719793265/sns-test-VMseriesHelperQueue-6SB52BS8O0IR", "\"]"]] },
            "    - [\"/usr/bin/python /opt/cfn-vm-series-helper-demo/helper.py > /var/log/helper.log 2>&1 &\"]",

            "output: {all: '| tee -a /var/log/cloud-config-output.log'}"
            ]]}
          }
      }
    }
  },

  "Outputs" : {
    "VMSHPublicDNSName": {
      "Description": "Public DNS of vm-series-helper instance",
      "Value": { "Fn::GetAtt": [ "VMSeriesHelperInstance", "PublicDnsName" ]}
    }
  }
}
